# Maintainer: Christopher Maltais <christopher.maltais@gmail.com>
#
# Pre-built binary package - NO Flutter dependency required!
# This package downloads a pre-built CloudToLocalLLM binary, so users
# don't need to install Flutter or any build dependencies.
#
pkgname=cloudtolocalllm
pkgver=3.4.0
pkgrel=1
pkgdesc="CloudToLocalLLM - Enhanced Architecture with System Tray Integration and Local LLM Management (Unified 145MB package)"
arch=('x86_64')
url="https://github.com/imrightguy/CloudToLocalLLM"
license=('MIT')
depends=(
    'libayatana-appindicator'
    'gtk3'
    'glib2'
    'cairo'
    'pango'
    'gdk-pixbuf2'
    'atk'
    'at-spi2-atk'
    'dbus'
    'xdg-utils'
    'hicolor-icon-theme'
    'python'  # For tray daemon
    'wmctrl'  # For window management
)
makedepends=()
optdepends=(
    'ollama: Local LLM server for direct desktop connectivity'
    'firefox: Web browser for authentication flow'
    'chromium: Alternative web browser for authentication'
)
provides=('cloudtolocalllm')
conflicts=('cloudtolocalllm-git')
install=cloudtolocalllm.install

# NOTE: CloudToLocalLLM v3.2.0+ uses GitHub releases for distribution
# All versions are now distributed via GitHub releases for better reliability
# AUR package downloads pre-built binaries from GitHub release assets

# Download from GitHub releases
source=(
    "cloudtolocalllm-${pkgver}-x86_64.tar.gz::https://github.com/imrightguy/CloudToLocalLLM/releases/download/v${pkgver}/cloudtolocalllm-${pkgver}-x86_64.tar.gz"
    "cloudtolocalllm-${pkgver}-x86_64.tar.gz.sha256::https://github.com/imrightguy/CloudToLocalLLM/releases/download/v${pkgver}/cloudtolocalllm-${pkgver}-x86_64.tar.gz.sha256"
)
sha256sums=(
    '3d8d458bcc5445854f026306551e18c3e75aea133543d655f7a3ed9c213e907b'  # cloudtolocalllm-3.3.1-x86_64.tar.gz (FIXED)
    'SKIP'  # Checksum file verification
)

prepare() {
    cd "$srcdir"

    msg "Extracting unified CloudToLocalLLM binary package..."

    # Verify checksum using downloaded SHA256 file
    local package_file="cloudtolocalllm-${pkgver}-x86_64.tar.gz"
    local checksum_file="${package_file}.sha256"

    if [[ ! -f "$package_file" ]]; then
        error "Unified binary package not found: $package_file"
        return 1
    fi

    # Verify integrity using the downloaded checksum file
    if [[ -f "$checksum_file" ]]; then
        msg "Verifying package integrity..."
        if ! sha256sum -c "$checksum_file"; then
            error "Package integrity verification failed"
            return 1
        fi
        msg "Package integrity verified successfully"
    fi

    # Extract the package (already extracted by makepkg)
    # Verify extraction - the unified package extracts to cloudtolocalllm-${pkgver}-x86_64 directory
    if [[ ! -f "cloudtolocalllm-${pkgver}-x86_64/cloudtolocalllm" ]]; then
        error "Main executable wrapper not found after extraction"
        return 1
    fi

    # Verify the new package structure with app directories
    if [[ ! -f "cloudtolocalllm-${pkgver}-x86_64/app/cloudtolocalllm" ]]; then
        error "Main Flutter executable not found in app/ directory"
        return 1
    fi

    # Create symlink for version compatibility
    if [[ ! -d "cloudtolocalllm-${pkgver}" ]]; then
        ln -sf "cloudtolocalllm-${pkgver}-x86_64" "cloudtolocalllm-${pkgver}"
    fi

    msg "Unified binary package extraction completed successfully"
}

build() {
    # No build steps required - using pre-built binary
    echo "Using pre-built binary package - no compilation needed"
}

package() {
    cd "$srcdir/cloudtolocalllm-${pkgver}"

    # Install the unified CloudToLocalLLM application
    install -dm755 "$pkgdir/usr/share/cloudtolocalllm"

    # Copy all files from the unified package
    cp -r * "$pkgdir/usr/share/cloudtolocalllm/"

    # Make all executables executable (new structure)
    chmod +x "$pkgdir/usr/share/cloudtolocalllm/cloudtolocalllm"
    chmod +x "$pkgdir/usr/share/cloudtolocalllm/cloudtolocalllm-main"
    chmod +x "$pkgdir/usr/share/cloudtolocalllm/cloudtolocalllm-tunnel-manager"

    # Make Flutter executables in app directories executable
    if [[ -f "$pkgdir/usr/share/cloudtolocalllm/app/cloudtolocalllm" ]]; then
        chmod +x "$pkgdir/usr/share/cloudtolocalllm/app/cloudtolocalllm"
    fi
    if [[ -f "$pkgdir/usr/share/cloudtolocalllm/main/cloudtolocalllm_main" ]]; then
        chmod +x "$pkgdir/usr/share/cloudtolocalllm/main/cloudtolocalllm_main"
    fi
    if [[ -f "$pkgdir/usr/share/cloudtolocalllm/tunnel-manager/cloudtolocalllm_tunnel_manager" ]]; then
        chmod +x "$pkgdir/usr/share/cloudtolocalllm/tunnel-manager/cloudtolocalllm_tunnel_manager"
    fi

    # Install Flutter application executables in /usr/bin
    install -dm755 "$pkgdir/usr/bin"

    # Create system wrapper scripts that use the new package structure
    cat > "$pkgdir/usr/bin/cloudtolocalllm" << 'EOF'
#!/bin/bash
# CloudToLocalLLM v3.3.1 main application system wrapper
cd /usr/share/cloudtolocalllm/app
exec ./cloudtolocalllm "$@"
EOF
    chmod +x "$pkgdir/usr/bin/cloudtolocalllm"

    cat > "$pkgdir/usr/bin/cloudtolocalllm-main" << 'EOF'
#!/bin/bash
# CloudToLocalLLM main chat application system wrapper
cd /usr/share/cloudtolocalllm/main
exec ./cloudtolocalllm_main "$@"
EOF
    chmod +x "$pkgdir/usr/bin/cloudtolocalllm-main"

    cat > "$pkgdir/usr/bin/cloudtolocalllm-tunnel-manager" << 'EOF'
#!/bin/bash
# CloudToLocalLLM tunnel manager application system wrapper
cd /usr/share/cloudtolocalllm/tunnel-manager
exec ./cloudtolocalllm_tunnel_manager "$@"
EOF
    chmod +x "$pkgdir/usr/bin/cloudtolocalllm-tunnel-manager"

    # Install desktop entry from the aur-package directory
    cd "$srcdir/.."
    if [[ -f "cloudtolocalllm.desktop" ]]; then
        install -Dm644 "cloudtolocalllm.desktop" \
            "$pkgdir/usr/share/applications/cloudtolocalllm.desktop"
    else
        # Create a basic desktop entry if not found
        cat > "$pkgdir/usr/share/applications/cloudtolocalllm.desktop" << 'EOF'
[Desktop Entry]
Version=1.0
Type=Application
Name=CloudToLocalLLM
GenericName=Multi-tenant Streaming LLM Management
Comment=Multi-tenant streaming LLM management with system tray integration
Exec=cloudtolocalllm
Icon=cloudtolocalllm
Terminal=false
Categories=Network;
Keywords=LLM;AI;Ollama;Chat;Machine Learning;
StartupNotify=true
EOF
    fi

    # Create a simple icon (placeholder) for desktop integration
    install -dm755 "$pkgdir/usr/share/pixmaps"
    install -dm755 "$pkgdir/usr/share/icons/hicolor/48x48/apps"

    # Create a simple text-based icon if no icon file is found
    if [[ ! -f "$pkgdir/usr/share/pixmaps/cloudtolocalllm.png" ]]; then
        # Create a minimal placeholder icon
        echo "CloudToLocalLLM Icon Placeholder" > "$pkgdir/usr/share/pixmaps/cloudtolocalllm.png"
        cp "$pkgdir/usr/share/pixmaps/cloudtolocalllm.png" "$pkgdir/usr/share/icons/hicolor/48x48/apps/"
    fi

    # Install documentation if present in the binary package
    if [[ -f "PACKAGE_INFO.txt" ]]; then
        install -Dm644 "PACKAGE_INFO.txt" "$pkgdir/usr/share/doc/$pkgname/PACKAGE_INFO.txt"
    fi
}
