# Dockerfile for the Tunnel Service (Flutter-based)
FROM ghcr.io/cirruslabs/flutter:latest AS build

# Create a non-root user and group
RUN groupadd -r flutteruser && useradd --no-log-init -r -g flutteruser -m -s /bin/bash flutteruser

WORKDIR /app

# Copy pubspec files and get dependencies
# Copy source and change ownership
COPY --chown=flutteruser:flutteruser pubspec.* ./
COPY --chown=flutteruser:flutteruser bin/ ./bin/
# Add other necessary source code directories for the tunnel service here, e.g.:
# COPY --chown=flutteruser:flutteruser lib/ ./lib/ 
# COPY --chown=flutteruser:flutteruser cloud/ ./cloud/ 

# Switch to non-root user for build
USER flutteruser

# Mark Flutter SDK directory as safe for git operations by non-root user
RUN git config --global --add safe.directory /sdks/flutter

RUN flutter pub get

# Build the Dart server/CLI app (bin/server.dart)
# Ensure this path is correct for your tunnel service entry point
RUN dart compile exe bin/server.dart -o /output/server 

# Final stage - minimal image to run the server
FROM scratch
COPY --from=build /output/server /app/server

# Expose port if needed by the tunnel service (e.g., 8080 or 3000)
EXPOSE 8080 

ENTRYPOINT ["/app/server"] 